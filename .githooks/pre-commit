#!/bin/bash
#
# Pre-commit hook for FreeCAD FCStd files.
# Warns if FCStd file is newer than its exploded directory.
#

set -e

# Find all FCStd files that are being tracked or staged
for fcstd in $(git diff --cached --name-only | grep -E '\.fcstd\.d/' | sed 's|/[^/]*$||' | sort -u); do
    dir="$fcstd"
    fcstd_file="${dir%.fcstd.d}.FCStd"

    if [ -f "$fcstd_file" ] && [ -d "$dir" ]; then
        fcstd_mtime=$(stat -c %Y "$fcstd_file" 2>/dev/null || stat -f %m "$fcstd_file" 2>/dev/null)

        # Find newest file in directory
        dir_mtime=0
        while IFS= read -r -d '' file; do
            file_mtime=$(stat -c %Y "$file" 2>/dev/null || stat -f %m "$file" 2>/dev/null)
            if [ "$file_mtime" -gt "$dir_mtime" ]; then
                dir_mtime=$file_mtime
            fi
        done < <(find "$dir" -type f -print0)

        if [ "$fcstd_mtime" -gt "$dir_mtime" ]; then
            echo "WARNING: $fcstd_file is newer than $dir"
            echo "         Run: python -m scripts.fcstd explode $fcstd_file"
            echo ""
            echo "Proceeding anyway. Consider running explode to capture latest changes."
        fi
    fi
done

exit 0
